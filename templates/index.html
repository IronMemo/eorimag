<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EORIMAG – Simplu, 100% online</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo-eorimag.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <div class="layout-two-col">
    <!-- Coloana stângă (informativă) -->
    <aside class="left-info">
      <img src="{{ url_for('static', filename='logo-eorimag.png') }}" alt="EORIMAG" class="logo-img" />
      <h1>Simplu <br>100% online</h1>
      <p class="tagline">
        Completezi formularul, atașezi actele și semnezi — noi depunem solicitarea la autoritatea vamală. Primești confirmarea pe email.
      </p>
      <ul>
        <li>Termen eliberare 1–3 zile</li>
        <li>Semnătură digitală în pagină</li>
        <li>Plată securizată prin Stripe</li>
        <li>Suport prin email</li>
        <li>Procesarea este realizată de autoritatea vamală, timpii pot varia</li>
      </ul>
    </aside>

    <!-- Coloana dreaptă (formular) -->
    <main class="right-form">
      <form id="orderForm" enctype="multipart/form-data" novalidate>
        <!-- Servicii -->
        <div class="service-grid" id="serviceGrid" role="radiogroup" aria-label="Alege serviciul">
          <input type="hidden" name="service_key" id="service_key" value="eori_ro">

          <button type="button" class="service-card selected" data-key="eori_ro" aria-pressed="true">
            <span class="title">Obținere cod EORI: Persoană Fizică</span>
            <span class="price">75 RON</span>
          </button>

          <button type="button" class="service-card" data-key="eori_update" aria-pressed="false">
            <span class="title">Obținere cod EORI: Persoană Juridică</span>
            <span class="price">99 RON</span>
          </button>
        </div>

        <!-- Date solicitant -->
        <div class="grid form-grid">
          <label>Nume și prenume*
            <input name="full_name" placeholder="Ex. Popescu Andrei" required>
          </label>
          <label>Companie (opțional)
            <input name="company" placeholder="Ex. SC Exemplu SRL">
          </label>
          <label>Email*
            <input type="email" name="email" placeholder="adresa@exemplu.ro" required>
          </label>
          <label>Telefon*
            <input type="tel" name="phone" placeholder="07xx xxx xxx" required>
          </label>
        </div>

        <label>CNP/CUI*
          <input name="cnp_cui" required>
        </label>

        <!-- Semnătură -->
        <div class="signature-block">
          <div class="sig-header">
            <strong>Semnătură *</strong>
            <span class="muted">Semnează cu mouse-ul sau degetul (pe telefon)</span>
          </div>
          <div class="sig-wrap">
            <!-- Dimensiunea finală este controlată de CSS; JS face scale pentru HiDPI -->
            <canvas id="sigpad"></canvas>
          </div>
          <div class="sig-actions">
            <button type="button" id="sigClear" class="secondary">Șterge semnătura</button>
            <button type="button" id="sigUndo" class="secondary">Undo</button>
          </div>
          <input type="hidden" name="signature_data" id="signature_data" required>
        </div>

        <!-- Upload documente -->
        <div class="uploads" style="margin-top:12px">
          <div>
            <span>Carte de identitate – față (JPG/PNG/PDF) *</span>
            <input type="file" name="id_front" accept=".pdf,.jpg,.jpeg,.png" required>
          </div>
          <div>
            <span>Carte de identitate – verso (opțional)</span>
            <input type="file" name="id_back" accept=".pdf,.jpg,.jpeg,.png">
          </div>
          <div>
            <span>Document suplimentar – opțional</span>
            <input type="file" name="extra_doc" accept=".pdf,.jpg,.jpeg,.png">
          </div>
        </div>

        <!-- Observații -->
        <label style="margin-top:12px">Observații (opțional)
          <input name="notes" placeholder="Detalii utile pentru solicitare">
        </label>

        <!-- Total + Termeni + Submit -->
        <div style="display:flex; flex-direction:column; gap:12px; margin-top:12px;">

          <!-- total -->
          <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
            <div id="totalBox" class="secondary" style="padding:10px 12px; border-radius:8px; border:1px solid #ddd;">
              <strong>Total estimat:</strong> <span id="totalVal">—</span>
            </div>
          </div>

          <!-- checkbox termeni -->
          <div class="terms-box" style="font-size:0.9rem; line-height:1.4; color:#333; display:flex; align-items:flex-start; gap:8px;">
            <input
              type="checkbox"
              id="accept_terms"
              name="accept_terms"
              required
              style="margin-top:3px; accent-color:#007bff; flex-shrink:0;"
            >
            <label for="accept_terms" style="cursor:pointer;">
              Confirm că am citit și sunt de acord cu
              <a href="/termeni" target="_blank" style="color:#007bff; text-decoration:none;">Termenii și Condițiile</a>,
              și sunt de acord ca datele mele personale și documentele încărcate să fie folosite pentru depunerea solicitării mele de cod EORI la autoritatea vamală.
            </label>
          </div>

          <!-- buton trimite -->
          <div>
            <button type="submit" id="payBtn">Trimite solicitarea</button>
          </div>
        </div>

        <p id="msg" class="muted"></p>
      </form>
    </main>
  </div>


  <script>
    // --- Selectarea serviciului + total ---
    const serviceGrid  = document.getElementById('serviceGrid');
    const serviceKeyEl = document.getElementById('service_key');
    const totalVal     = document.getElementById('totalVal');

    // Prețuri afișate
    const PRICE_LABELS = {
      eori_ro:     '75 RON',   // Persoană Fizică
      eori_update: '99 RON',   // Persoană Juridică
      gb_eori:     '149 RON',
      resend:      '49 RON'
    };

    function updateTotalFromKey(key){
      totalVal.textContent = PRICE_LABELS[key] || '—';
      // mic efect vizual
      totalVal.style.opacity = '0.3';
      requestAnimationFrame(() => { totalVal.style.opacity = '1'; });
    }

    // Setează totalul corect la încărcare
    updateTotalFromKey(serviceKeyEl.value || 'eori_ro');

    // Click pe card -> selectare + actualizare total
    serviceGrid.addEventListener('click', (e) => {
      const btn = e.target.closest('.service-card');
      if (!btn) return;

      document.querySelectorAll('.service-card').forEach(b => {
        b.classList.remove('selected');
        b.setAttribute('aria-pressed', 'false');
      });

      btn.classList.add('selected');
      btn.setAttribute('aria-pressed', 'true');

      const key = btn.dataset.key;  // eori_ro / eori_update ...
      serviceKeyEl.value = key;
      updateTotalFromKey(key);
    });

    // --- Semnătură pe canvas (fără librărie externă) ---
    const canvas = document.getElementById('sigpad');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let strokes = []; // pentru undo
    let currentStroke = [];

    // Scale pentru HiDPI / Retina (claritate)
    function resizeSigCanvas(){
      const dpr  = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      // setăm dimensiunea vizibilă (CSS) dacă nu are una
      if (!canvas.style.width) canvas.style.width = '100%';
      if (!canvas.style.height) canvas.style.height = '200px';

      // sincronizare cu stilul vizibil
      const cssWidth  = rect.width  || canvas.clientWidth  || 600;
      const cssHeight = rect.height || canvas.clientHeight || 200;

      canvas.width  = Math.max(1, Math.round(cssWidth  * dpr));
      canvas.height = Math.max(1, Math.round(cssHeight * dpr));

      ctx.setTransform(1, 0, 0, 1, 0, 0); // reset transform
      ctx.scale(dpr, dpr);
      redraw();
    }

    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      const t = evt.touches ? evt.touches[0] : evt;
      return {
        x: (t.clientX - rect.left),
        y: (t.clientY - rect.top)
      };
    }

    function redraw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.lineWidth = 2 * (window.devicePixelRatio || 1);
      ctx.lineJoin = 'round';
      ctx.lineCap  = 'round';
      ctx.strokeStyle = '#111';
      strokes.forEach(st => {
        ctx.beginPath();
        st.forEach((p,i) => {
          if (i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
        });
        ctx.stroke();
      });
    }

    function startDraw(evt) {
      drawing = true;
      currentStroke = [];
      const p = getPos(evt);
      currentStroke.push(p);
      evt.preventDefault();
    }
    function moveDraw(evt) {
      if (!drawing) return;
      const p = getPos(evt);
      currentStroke.push(p);
      redraw();
      // trasează curentul live
      ctx.lineWidth = 2 * (window.devicePixelRatio || 1);
      ctx.beginPath();
      currentStroke.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
      ctx.stroke();
      evt.preventDefault();
    }
    function endDraw(evt) {
      if (!drawing) return;
      drawing = false;
      if (currentStroke.length > 1) {
        strokes.push(currentStroke);
        redraw();
      }
      evt && evt.preventDefault();
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    window.addEventListener('mouseup', endDraw);
    canvas.addEventListener('touchstart', startDraw, {passive:false});
    canvas.addEventListener('touchmove',  moveDraw,  {passive:false});
    canvas.addEventListener('touchend',   endDraw);

    document.getElementById('sigClear').addEventListener('click', () => {
      strokes = [];
      redraw();
    });
    document.getElementById('sigUndo').addEventListener('click', () => {
      strokes.pop();
      redraw();
    });

    function canvasToDataURL() {
      if (!strokes.length) return '';
      // export în rezoluție nativă
      return canvas.toDataURL('image/png');
    }

    // Initializează canvas-ul pentru DPI curent și pe resize
    resizeSigCanvas();
    window.addEventListener('resize', resizeSigCanvas);

    // --- Submit către /create-checkout (Stripe Checkout) ---
    const form = document.getElementById('orderForm');
    const msg = document.getElementById('msg');
    const sigHidden = document.getElementById('signature_data');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';

      // pune semnătura în hidden
      sigHidden.value = canvasToDataURL();

      const fd = new FormData(form);
      try {
        const resp = await fetch('/create-checkout', { method: 'POST', body: fd });
        const data = await resp.json();
        if (!resp.ok || !data.checkout_url) {
          throw new Error(data.error || 'Eroare la inițierea plății.');
        }
        // redirect la Stripe Checkout
        window.location.href = data.checkout_url;
      } catch (err) {
        msg.textContent = err.message || 'A apărut o eroare. Reîncearcă.';
      }
    });
  </script>
</body>
</html>
