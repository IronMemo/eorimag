<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Eorimag – Cod EORI 100% online</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="layout-two-col">
    <!-- Stânga: branding + beneficii scurte -->
    <section class="left-info">
      <div class="brand">
        <img src="{{ url_for('static', filename='logo-eorimag.png') }}" alt="Eorimag logo" class="logo-img">
        <h1>Cod EORI – simplu, 100% online</h1>
        <p class="tagline">
          Completezi în 3–5 minute. Plătești online. Semnezi digital. Noi procesăm.
        </p>
        <ul class="benefits">
          <li>✔️ Formulare clare, pași ghidați</li>
          <li>✔️ Încarci actele direct din telefon</li>
          <li>✔️ Semnătură pe ecran (touch/mouse)</li>
          <li>✔️ Confirmare pe email</li>
        </ul>
      </div>
    </section>

    <!-- Dreapta: FORMULAR -->
    <section class="right-form card">
      <form id="orderForm">
        <!-- 4 opțiuni mari, clickabile -->
        <div class="service-grid" id="serviceGrid" role="radiogroup" aria-label="Alege serviciul">
          <input type="hidden" name="service_key" id="service_key" value="eori_ro">

          <button type="button" class="service-card selected" data-key="eori_ro" role="radio" aria-checked="true" tabindex="0">
            <span class="title">EORI România</span>
            <span class="desc">PF / PJ – obținere cod nou</span>
          </button>

          <button type="button" class="service-card" data-key="eori_update" role="radio" aria-checked="false" tabindex="0">
            <span class="title">Actualizare EORI</span>
            <span class="desc">Modificare/actualizare date</span>
          </button>

          <button type="button" class="service-card" data-key="gb_eori" role="radio" aria-checked="false" tabindex="0">
            <span class="title">GB EORI (UK)</span>
            <span class="desc">Marea Britanie</span>
          </button>

          <button type="button" class="service-card" data-key="resend" role="radio" aria-checked="false" tabindex="0">
            <span class="title">Retrimitere documente</span>
            <span class="desc">Reprimi pe email</span>
          </button>
        </div>

        <!-- Date solicitant (FĂRĂ Observații) -->
        <div class="grid form-grid">
          <label>
            Nume complet*
            <input name="full_name" autocomplete="name" required>
          </label>

          <label>
            Email*
            <input type="email" name="email" autocomplete="email" required>
          </label>

          <label>
            Telefon*
            <input name="phone" autocomplete="tel" required>
          </label>

          <label>
            CNP/CUI*
            <input name="cnp_cui" required>
          </label>
        </div>

        <!-- Upload documente -->
        <div class="uploads">
          <div>
            <span>Carte identitate (față) – JPG/PNG/PDF</span>
            <input type="file" name="id_front" accept=".pdf,.jpg,.jpeg,.png">
          </div>
          <div>
            <span>Carte identitate (verso) – opțional</span>
            <input type="file" name="id_back" accept=".pdf,.jpg,.jpeg,.png">
          </div>
          <div>
            <span>Document suplimentar – opțional</span>
            <input type="file" name="extra_doc" accept=".pdf,.jpg,.jpeg,.png">
          </div>
        </div>

        <!-- Semnătură (canvas) -->
        <div class="signature-block">
          <div class="sig-header">
            <strong>Semnătură</strong>
            <span class="muted">Semnează cu mouse-ul sau degetul (pe telefon)</span>
          </div>
          <div class="sig-wrap">
            <canvas id="sigpad" width="600" height="200"></canvas>
          </div>
          <div class="sig-actions">
            <button type="button" id="sigClear" class="secondary">Șterge</button>
            <button type="button" id="sigUndo" class="secondary">Undo</button>
          </div>
          <input type="hidden" name="signature_data" id="signature_data">
        </div>

        <button type="submit" id="payBtn">Plătește</button>
        <p id="msg" class="muted"></p>
      </form>
    </section>
  </main>

  <script>
  /* ===== Selecție servicii (robust) ===== */
  const serviceInput = document.getElementById('service_key');
  const cards = Array.from(document.querySelectorAll('.service-card'));

  function selectCard(card) {
    cards.forEach(c => {
      const isSel = (c === card);
      c.classList.toggle('selected', isSel);
      c.setAttribute('aria-checked', isSel ? 'true' : 'false');
    });
    serviceInput.value = card.dataset.key;
  }

  cards.forEach(card => {
    card.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      selectCard(card);
    });
    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        selectCard(card);
      }
    });
  });

  /* ===== Signature Pad minimalist ===== */
  const canvas = document.getElementById('sigpad');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let points = [];
  let strokes = []; // pentru Undo

  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    if (evt.touches && evt.touches[0]) {
      return { x: evt.touches[0].clientX - rect.left, y: evt.touches[0].clientY - rect.top };
    }
    return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
  }

  function redraw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#111';
    strokes.forEach(stroke => {
      ctx.beginPath();
      stroke.forEach((p, i) => i===0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
      ctx.stroke();
    });
    if (points.length) {
      ctx.beginPath();
      points.forEach((p, i) => i===0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
      ctx.stroke();
    }
  }

  const start = (e) => { drawing = true; points = []; strokes.push(points); points.push(getPos(e)); redraw(); };
  const move  = (e) => { if (!drawing) return; points.push(getPos(e)); redraw(); };
  const end   = () => { drawing = false; };

  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  window.addEventListener('mouseup', end);

  canvas.addEventListener('touchstart', (e)=>{e.preventDefault(); start(e);}, {passive:false});
  canvas.addEventListener('touchmove',  (e)=>{e.preventDefault(); move(e);}, {passive:false});
  canvas.addEventListener('touchend',   (e)=>{e.preventDefault(); end();}, {passive:false});

  document.getElementById('sigClear').addEventListener('click', () => { strokes = []; points = []; redraw(); });
  document.getElementById('sigUndo').addEventListener('click', () => { strokes.pop(); points = []; redraw(); });

  function sigIsEmpty() { return strokes.length === 0; }

  /* ===== Submit -> Stripe ===== */
  const form = document.getElementById('orderForm');
  const msg  = document.getElementById('msg');
  const btn  = document.getElementById('payBtn');
  const sigHidden = document.getElementById('signature_data');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    btn.disabled = true;

    // atașează semnătura PNG dacă există
    if (!sigIsEmpty()) {
      sigHidden.value = canvas.toDataURL('image/png');
    } else {
      sigHidden.value = '';
    }

    try {
      const fd = new FormData(form);
      const res = await fetch('/create-checkout', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Eroare');

      window.location.href = data.checkout_url;
    } catch (err) {
      msg.textContent = err.message || 'A apărut o eroare. Încearcă din nou.';
      btn.disabled = false;
    }
  });
  </script>
</body>
</html>
